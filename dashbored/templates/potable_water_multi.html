{% extends "base.html" %}

{% block title %}Potable Water - {{ vessel.vessel_name }}{% endblock %}

<style>
    /* Quick Preset button styling for compact sidebar fit */
    .date-preset {
        font-size: 0.5rem !important;
        padding: 0.25rem 0 !important;
        height: auto !important;
        box-sizing: border-box !important;
        line-height: 1.1 !important;
        white-space: nowrap !important;
        text-align: center !important;
        width: 100% !important;
        min-width: 0 !important;
    }
    .text-muted.d-block.mb-1 {
        font-size: 0.7rem !important;
    }
    /* Grid layout for preset buttons - 2 columns, 3 rows */
    .preset-btn-container {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 2px !important;
    }
    .preset-btn-container .btn {
        flex: none !important;
        min-width: 0 !important;
        max-width: none !important;
        width: 100% !important;
    }

    /* Collapsible specs chevron animation */
    .specs-chevron {
        transition: transform 0.3s ease;
    }
    [data-bs-toggle="collapse"][aria-expanded="true"] .specs-chevron {
        transform: rotate(180deg);
    }
</style>

{% block content %}
<div class="container-fluid mt-4">
    <!-- Breadcrumb and Title -->
    <div class="row mb-3">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard', vessel_id=vessel.id) }}">Dashboard</a></li>
                    <li class="breadcrumb-item active">Potable Water</li>
                </ol>
            </nav>
            <h2><i class="bi bi-cup-straw text-info"></i> Potable Water Analysis</h2>
            <p class="text-muted">{{ vessel.vessel_name }}</p>
        </div>
    </div>

    <div class="row">
        <!-- Left Sidebar -->
        <div class="col-md-3 col-lg-2 mb-4">
            <!-- Sampling Point Selection -->
            <div class="card mb-3">
                <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-check2-square"></i> Select Points</h6>
                    <div class="form-check">
                        <input class="form-check-input pw-checkbox" type="checkbox" value="PW1" id="pw1-check" checked>
                        <label class="form-check-label" for="pw1-check">
                            <i class="bi bi-droplet-fill text-primary"></i> PW1: Galley
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input pw-checkbox" type="checkbox" value="PW2" id="pw2-check" checked>
                        <label class="form-check-label" for="pw2-check">
                            <i class="bi bi-droplet-fill text-success"></i> PW2: Accommodation
                        </label>
                    </div>
                    <hr>
                    <button class="btn btn-sm btn-outline-primary w-100 mb-2" id="select-all">
                        <i class="bi bi-check-all"></i> Select All
                    </button>
                    <button class="btn btn-sm btn-outline-secondary w-100" id="deselect-all">
                        <i class="bi bi-x-square"></i> Deselect All
                    </button>
                </div>
            </div>

            <!-- Date Range Filter -->
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-calendar-range"></i> Date Range</h6>
                    <form method="GET" id="filter-form">
                        <div class="mb-3">
                            <label for="start_date" class="form-label"><strong>Start Date</strong></label>
                            <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date }}">
                        </div>
                        <div class="mb-3">
                            <label for="end_date" class="form-label"><strong>End Date</strong></label>
                            <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date }}">
                        </div>

                        <!-- Quick Presets -->
                        <small class="text-muted d-block mb-1">Quick Presets:</small>
                        <div class="preset-btn-container w-100 mb-3">
                            <button type="button" class="btn btn-outline-primary btn-sm date-preset" data-days="30">30D</button>
                            <button type="button" class="btn btn-outline-primary btn-sm date-preset" data-days="90">90D</button>
                            <button type="button" class="btn btn-outline-primary btn-sm date-preset" data-days="180">6mo</button>
                            <button type="button" class="btn btn-outline-primary btn-sm date-preset" data-days="365">1yr</button>
                            <button type="button" class="btn btn-outline-primary btn-sm date-preset" data-days="1095">3YR</button>
                            <button type="button" class="btn btn-outline-primary btn-sm date-preset" data-days="all">All</button>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 mb-2">
                            <i class="bi bi-funnel"></i> Apply Filter
                        </button>
                        <button type="button" class="btn btn-secondary w-100 mb-3" onclick="window.location.href='{{ url_for('potable_water', vessel_id=vessel.id) }}'">
                            <i class="bi bi-x-circle"></i> Reset
                        </button>
                    </form>

                    <!-- Specific Date Filter -->
                    <div class="mt-3 pt-3" style="border-top: 1px solid #dee2e6;">
                        <label for="specific-date" class="form-label"><strong><i class="bi bi-calendar-date"></i> Specific Date</strong></label>
                        <select class="form-select form-select-sm" id="specific-date">
                            <option value="all" selected>All Dates</option>
                            <!-- Options populated by JavaScript -->
                        </select>
                        <small class="text-muted d-block mt-1">Filter by specific test date</small>
                    </div>
                </div>
            </div>

        </div>

        <!-- Main Content -->
        <div class="col-md-6 col-lg-7">
            <div class="card">
                <div class="card-body">
                    {% if pw_data %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="pw-table">
                                <thead class="table-primary">
                                    <tr>
                                        <th>Date</th>
                                        <th>Point</th>
                                        <th>Parameter</th>
                                        <th>Value</th>
                                    <th>Unit</th>
                                        <th>Ideal Range</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="pw-table-body">
                                    <!-- Data populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle"></i> No potable water data available for the selected date range.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Sidebar -->
        <div class="col-md-3 col-lg-3 mb-4">
            <!-- Vessel Selector (hidden for vessel users) -->
            {% if not current_user.is_vessel_user() %}
            <div class="card mb-3">
                <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-ship"></i> Select Vessel</h6>
                    <select class="form-select" id="vessel-selector">
                        {% for v in vessels %}
                        <option value="{{ v.id }}" {% if v.id == vessel.id %}selected{% endif %}>
                            {{ v.vessel_name }}
                        </option>
                        {% endfor %}
                    </select>
                    <p class="text-muted small mt-2 mb-0">{{ vessel.vessel_id }}</p>
                </div>
            </div>
            {% endif %}


            <!-- PDF Download Button -->
            <div class="card mb-3">
                <div class="card-body text-center">
                    <button type="button" class="btn btn-success w-100" id="download-pdf-btn" onclick="downloadPagePDF()">
                        <i class="bi bi-file-earmark-pdf"></i> Download PDF
                    </button>
                    <small class="text-muted d-block mt-2">Generate report for current view</small>
                </div>
            </div>
            <!-- Vessel Equipment Specifications -->
            {% if vessel_specs %}
            <div class="card mb-3">
                <div class="card-header" style="background-color: #6c757d; color: white; cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#specsCollapse" aria-expanded="false" aria-controls="specsCollapse">
                    <h6 class="mb-0 d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-info-circle-fill"></i> Equipment Specifications</span>
                        <i class="bi bi-chevron-down specs-chevron"></i>
                    </h6>
                </div>
                <div class="collapse" id="specsCollapse">
                <div class="card-body">
                    {% for category, fields in vessel_specs.items() %}
                        {% if category != 'vessel_info' %}
                            {% for field_name, field_value in fields.items() %}
                                <div class="mb-2">
                                    <small class="text-muted d-block">{{ field_name }}</small>
                                    <strong class="small">{{ field_value }}</strong>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                </div>
                </div>
            </div>
            {% endif %}

            <!-- Parameter Limits -->
            <div class="card mb-3">
                <div class="card-header" style="background-color: #0071e3; color: white;">
                    <h6 class="mb-0"><i class="bi bi-sliders"></i> Parameter Limits</h6>
                </div>
                <div class="card-body">
                    <div id="limits-sidebar" style="max-height: 300px; overflow-y: auto; font-size: 0.85rem;">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Potable Water Alerts -->
            <div class="card border-danger">
                <div class="card-header" style="background-color: #dc3545; color: white;">
                    <h6 class="mb-0 text-white"><i class="bi bi-exclamation-triangle-fill"></i> Potable Water Alerts</h6>
                </div>
                <div class="card-body">
                    {% if alerts %}
                        <div class="list-group list-group-flush">
                            {% for alert in alerts[:5] %}
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="small">
                                        <strong>{{ alert.sampling_point_name or 'N/A' }}</strong><br>
                                        <span class="text-muted">{{ alert.parameter_name }}</span><br>
                                        <span class="badge bg-danger">{{ alert.measured_value }}</span>
                                        <small class="text-muted">{{ alert.alert_date[:10] }}</small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="mb-0" style="color: #6e6e73;">
                            <i class="bi bi-check-circle-fill" style="color: #0071e3;"></i> No active alerts
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Out of Range helper functions
function formatMeasurementValue(value) {
    const numValue = parseFloat(value);
    if (numValue >= 99999999999 || numValue <= -99999999999) {
        return "Out of Range";
    }
    return value;
}
function isOutOfRange(value) {
    const numValue = parseFloat(value);
    return numValue >= 99999999999 || numValue <= -99999999999;
}

// Vessel selector - reload page when vessel changes
const vesselSelector = document.getElementById('vessel-selector');
if (vesselSelector) {
    vesselSelector.addEventListener('change', function() {
        const newVesselId = this.value;
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('vessel_id', newVesselId);
        window.location.href = currentUrl.toString();
    });
}

// Color palette for sampling points
const PW_COLORS = {
    'PW1': '#0d6efd',  // Blue
    'PW2': '#198754'   // Green
};

// Convert date from YYYY-MM-DD or full timestamp to dd-mm-yy format
function formatDateForHover(dateStr) {
    const datePart = dateStr.split(' ')[0];
    const parts = datePart.split('-');
    if (parts.length === 3) {
        const year = parts[0].slice(-2);
        const month = parts[1];
        const day = parts[2];
        return `${day}-${month}-${year}`;
    }
    return dateStr;
}

// PW selection management
const pwCheckboxes = document.querySelectorAll('.pw-checkbox');
const selectAllBtn = document.getElementById('select-all');
const deselectAllBtn = document.getElementById('deselect-all');

selectAllBtn.addEventListener('click', () => {
    pwCheckboxes.forEach(cb => cb.checked = true);
    updateTable();
});

deselectAllBtn.addEventListener('click', () => {
    pwCheckboxes.forEach(cb => cb.checked = false);
    updateTable();
});

pwCheckboxes.forEach(cb => {
    cb.addEventListener('change', updateTable);
});

function getSelectedPWs() {
    return Array.from(pwCheckboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);
}

// All data from backend
const allPWData = {{ pw_data | tojson }};

// Load parameter limits from backend
const limitsData = {{ limits | tojson | safe }};
console.log('Potable water limits loaded:', limitsData);

// Normalize parameter names to match database format (users.sqlite parameter_limits)
function normalizeParameterName(paramName) {
    const upperName = paramName.toUpperCase().trim();

    // Direct mappings to users.sqlite parameter_limits table format
    const mappings = {
        // pH variations
        'PH (PHPCATC)': 'PH',
        'PH-VALUE (MR)': 'PH',
        'PH-UNIVERSAL': 'PH',
        'PH': 'PH',

        // Turbidity
        'TURBIDITY-NTU': 'TURBIDITY',
        'TURBIDITY': 'TURBIDITY',

        // TDS
        'TDS': 'TOTAL DISSOLVED SOLIDS (TDS)',
        'TOTAL DISSOLVED SOLIDS': 'TOTAL DISSOLVED SOLIDS (TDS)',

        // Chlorine variations
        'CHLORINE FREE': 'FREE CHLORINE',
        'CHLORINE TOTAL': 'TOTAL CHLORINE',
        'CHLORINE COMBINED': 'COMBINED CHLORINE',

        // Hardness
        'HARDN.- TOTAL (HR)': 'TOTAL HARDNESS (AS CACO₃)',
        'HARDN.- TOTAL (LR)': 'TOTAL HARDNESS (AS CACO₃)',
        'HARDN.- TOTAL': 'TOTAL HARDNESS (AS CACO₃)',
        'TOTAL HARDNESS': 'TOTAL HARDNESS (AS CACO₃)',

        // Alkalinity
        'ALKALINITY M': 'TOTAL ALKALINITY (AS CACO₃)',
        'ALKALINITY M (HR TAB)': 'TOTAL ALKALINITY (AS CACO₃)',
        'TOTAL ALKALINITY': 'TOTAL ALKALINITY (AS CACO₃)',

        // Sulphate
        'SULPHATE (TAB)': 'SULPHATE (SO₄)',
        'SULPHATE': 'SULPHATE (SO₄)',

        // Iron
        'IRON (LR)': 'IRON (FE)',
        'IRON': 'IRON (FE)',

        // Nickel
        'NICKEL (HR LIQ)': 'NICKEL (NI)',
        'NICKEL (HR TAB)': 'NICKEL (NI)',
        'NICKEL': 'NICKEL (NI)',

        // Copper variations
        'COPPER FREE': 'COPPER (CU)',
        'COPPER TOTAL': 'COPPER (CU)',
        'COPPER COMBINED': 'COPPER (CU)',
        'COPPER FREE (POW)': 'COPPER (CU)',
        'COPPER': 'COPPER (CU)',

        // Zinc
        'ZINC': 'ZINC (ZN)',

        // Chloride
        'CHLORIDE (LIQ)': 'CHLORIDE',
        'CHLORIDE': 'CHLORIDE'
    };

    // Try exact match first
    if (mappings[upperName]) {
        return mappings[upperName];
    }

    // Try partial matches for common patterns
    for (const [pattern, target] of Object.entries(mappings)) {
        if (upperName.includes(pattern.split(' ')[0]) && pattern.split(' ')[0].length > 2) {
            // Check if first word matches
            const firstWord = pattern.split(' ')[0];
            if (upperName.startsWith(firstWord)) {
                return target;
            }
        }
    }

    // Return uppercase name as fallback
    return upperName;
}

// Populate limits sidebar
function populateLimitsSidebar() {
    const sidebar = document.getElementById('limits-sidebar');
    if (!sidebar || !limitsData) {
        return;
    }

    const sortedParams = Object.keys(limitsData).sort();
    let html = '<div class="list-group list-group-flush">';

    sortedParams.forEach(param => {
        const limits = limitsData[param];
        const lowerFormatted = limits.lower_limit % 1 === 0 ? limits.lower_limit.toFixed(0) : limits.lower_limit;
        const upperFormatted = limits.upper_limit % 1 === 0 ? limits.upper_limit.toFixed(0) : limits.upper_limit;

        // Capitalize parameter name for display
        const displayName = param.split(' ').map(word =>
            word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
        ).join(' ');

        html += `
            <div class="list-group-item p-2">
                <div class="d-flex justify-content-between align-items-start">
                    <span class="fw-bold text-primary" style="font-size: 0.8rem;">${displayName}</span>
                </div>
                <div class="text-muted" style="font-size: 0.75rem;">
                    <i class="bi bi-arrow-down-circle text-success"></i> ${lowerFormatted}
                    <i class="bi bi-arrow-up-circle text-warning ms-2"></i> ${upperFormatted}
                </div>
            </div>
        `;
    });

    html += '</div>';
    sidebar.innerHTML = html;
}

// Call on page load
document.addEventListener('DOMContentLoaded', populateLimitsSidebar);

function updateTable() {
    const selectedPWs = getSelectedPWs();
    const selectedDate = document.getElementById('specific-date').value;
    const tableBody = document.getElementById('pw-table-body');
    tableBody.innerHTML = '';

    // Filter data by selected sampling points
    let filteredData = allPWData.filter(m => selectedPWs.includes(m.pw_id));

    // Apply specific date filter if not "all"
    if (selectedDate !== 'all') {
        filteredData = filteredData.filter(m => {
            const measurementDate = m.measurement_date.split(' ')[0]; // Get date part only
            return measurementDate === selectedDate;
        });
    }

    // Sort by date (newest first), then by sampling point, then by parameter
    filteredData.sort((a, b) => {
        const dateCompare = new Date(b.measurement_date) - new Date(a.measurement_date);
        if (dateCompare !== 0) return dateCompare;

        const pwCompare = a.pw_id.localeCompare(b.pw_id);
        if (pwCompare !== 0) return pwCompare;

        return a.parameter_name.localeCompare(b.parameter_name);
    });

    // Populate table rows
    filteredData.forEach(m => {
        const row = document.createElement('tr');

        // Format date as dd-mm-yy
        const formattedDate = formatDateForHover(m.measurement_date);

        // Get limits from users.sqlite database via limitsData
        const normalizedParam = normalizeParameterName(m.parameter_name);
        const paramLimits = limitsData[normalizedParam];

        // Determine status badge and range from database limits
        let statusBadge = '<span class="badge bg-secondary">N/A</span>';
        let idealRange = 'N/A';
        let valueClass = '';

        if (paramLimits) {
            const value = parseFloat(m.value);
            const lowerLimit = parseFloat(paramLimits.lower_limit);
            const upperLimit = parseFloat(paramLimits.upper_limit);

            idealRange = `${lowerLimit} - ${upperLimit}`;

            if (isOutOfRange(m.value)) {
                    statusBadge = '<span class="badge bg-warning text-dark">OOR</span>';
                    valueClass = 'text-muted fst-italic';
                } else if (!isNaN(value) && !isNaN(lowerLimit) && !isNaN(upperLimit)) {
                if (value >= lowerLimit && value <= upperLimit) {
                    statusBadge = '<span class="badge bg-success">OK</span>';
                } else {
                    statusBadge = '<span class="badge bg-danger">ALERT</span>';
                    valueClass = 'text-danger fw-bold';
                }
            }
        }

        // Color code the sampling point
        const pwColor = PW_COLORS[m.pw_id] || '#6c757d';
        const pwBadge = `<span class="badge" style="background-color: ${pwColor}">${m.pw_id}</span>`;

        row.innerHTML = `
            <td>${formattedDate}</td>
            <td>${pwBadge}</td>
            <td>${m.parameter_name}</td>
            <td class="${valueClass}"><strong>${formatMeasurementValue(m.value)}</strong></td>
            <td>${m.unit || ''}</td>
            <td>${idealRange}</td>
            <td>${statusBadge}</td>
        `;

        tableBody.appendChild(row);
    });

    // If no data, show message
    if (filteredData.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="7" class="text-center text-muted">No data available for selected sampling points</td>';
        tableBody.appendChild(row);
    }
}

// Quick date presets
document.querySelectorAll('.date-preset').forEach(btn => {
    btn.addEventListener('click', function() {
        const days = this.getAttribute('data-days');
        const endDate = new Date();
        let startDate;

        if (days === 'all') {
            startDate = new Date('2000-01-01');
        } else {
            startDate = new Date();
            startDate.setDate(startDate.getDate() - parseInt(days));
        }

        document.getElementById('start_date').value = startDate.toISOString().split('T')[0];
        document.getElementById('end_date').value = endDate.toISOString().split('T')[0];
    });
});

// Populate specific date filter dropdown
function populateSpecificDateFilter() {
    const specificDateFilter = document.getElementById('specific-date');
    const uniqueDates = new Set();

    // Get all unique dates from data
    allPWData.forEach(m => {
        const dateOnly = m.measurement_date.split(' ')[0]; // Get date part only (YYYY-MM-DD)
        uniqueDates.add(dateOnly);
    });

    // Sort dates in descending order (newest first)
    const sortedDates = Array.from(uniqueDates).sort((a, b) => {
        return new Date(b) - new Date(a);
    });

    // Add options to dropdown with formatted dates
    sortedDates.forEach(dateStr => {
        const option = document.createElement('option');
        option.value = dateStr;

        // Format date as dd-mm-yy for display
        const parts = dateStr.split('-');
        if (parts.length === 3) {
            const year = parts[0].slice(-2);
            const month = parts[1];
            const day = parts[2];
            option.textContent = `${day}-${month}-${year}`;
        } else {
            option.textContent = dateStr;
        }

        specificDateFilter.appendChild(option);
    });
}

// Specific date filter event listener
const specificDateFilter = document.getElementById('specific-date');
if (specificDateFilter) {
    specificDateFilter.addEventListener('change', updateTable);
}

// Initial setup
if (allPWData && allPWData.length > 0) {
    populateSpecificDateFilter();
    updateTable();
}

// Download PDF for current page view
function downloadPagePDF() {
    const btn = document.getElementById('download-pdf-btn');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Generating...';
    btn.disabled = true;
    
    // Get date range
    const startDate = document.getElementById('start_date').value;
    const endDate = document.getElementById('end_date').value;
    
    // Build URL with parameters
    let url = '/api/reports/potable-water-pdf?vessel_id={{ vessel.id }}';
    url += '&start_date=' + startDate;
    url += '&end_date=' + endDate;
    
    // Fetch PDF
    fetch(url)
        .then(response => {
            if (!response.ok) throw new Error('PDF generation failed');
            return response.blob();
        })
        .then(blob => {
            const downloadUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = downloadUrl;
            a.download = '{{ vessel.vessel_name }}_PotableWater_' + startDate + '_' + endDate + '.pdf';
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(downloadUrl);
        })
        .catch(error => {
            alert('Error generating PDF: ' + error.message);
        })
        .finally(() => {
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        });
}
</script>
{% endblock %}
