
def run_sync_command(vessel_str_id):
    """Helper to run the sync script for a vessel"""
    base_dir = os.path.dirname(os.path.abspath(__file__))
    script_path = os.path.abspath(os.path.join(base_dir, '../datafetcher/src/fetch_and_store.py'))
    config_path = os.path.abspath(os.path.join(base_dir, '../datafetcher/config/vessels_config.yaml'))
    db_path = os.path.abspath(os.path.join(base_dir, '../datafetcher/data/accubase.sqlite'))
    
    cmd = [
        sys.executable,
        script_path,
        vessel_str_id,
        "30", # Default 30 days
        "--config", config_path,
        "--db", db_path
    ]
    
    try:
        result = subprocess.run(
            cmd, 
            capture_output=True, 
            text=True, 
            check=True
        )
        return True, result.stdout
    except subprocess.CalledProcessError as e:
        return False, e.stderr
    except Exception as e:
        return False, str(e)

@app.route('/sync_all_vessels', methods=['POST'])
@login_required
def sync_all_vessels():
    """
    Trigger data fetch for ALL accessible vessels
    """
    # Get all accessible vessels
    vessel_ids = current_user.get_accessible_vessels()
    if not vessel_ids:
        return jsonify({'success': False, 'message': 'No vessels found'}), 404
        
    vessels = get_vessels_by_ids(vessel_ids)
    
    results = []
    success_count = 0
    
    for vessel in vessels:
        vessel_name = vessel['vessel_name']
        vessel_str_id = vessel['vessel_id']
        
        app.logger.info(f"Syncing {vessel_name} ({vessel_str_id})...")
        
        success, output = run_sync_command(vessel_str_id)
        
        results.append({
            'vessel_name': vessel_name,
            'success': success,
            'message': 'Synced successfully' if success else f'Failed: {output[:100]}...'
        })
        
        if success:
            success_count += 1
            
    return jsonify({
        'success': True,
        'total': len(vessels),
        'success_count': success_count,
        'results': results
    })
